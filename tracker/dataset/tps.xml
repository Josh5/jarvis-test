<!--
  Transactions per second query
  -->
<dataset read="*" write="">
    <select>
    <![CDATA[
        SELECT 
            datetime(cal.time) as t
            , SUM (CASE WHEN r.start_time IS NOT NULL THEN 1 ELSE 0 END) / 15.0 AS c 
        FROM 
            (SELECT the_date + i.interval as time FROM
                (
                -- I'm using 'cast' here as a poor man's truncate(). The cast/round ensure I get all days partially
                -- covered by from and to.
                SELECT the_date FROM calendar WHERE the_date >= CAST({$from} AS INTEGER) AND the_date <= round({$to})
                ) c,
                (
                SELECT interval FROM day_interval WHERE is_fifteen_minute = 1
                ) i
            ) cal
            LEFT JOIN request r ON 
                cal.time <= start_time AND cal.time + (15.0 / (60 * 24)) > start_time
        WHERE
            time >= CAST({$from} AS FLOAT) AND time <= CAST({$to} AS FLOAT) 
            AND (app_name IS NULL OR {$1} IS NULL OR {$1} = app_name)
        GROUP BY 
            cal.time
        ORDER BY
            cal.time
    ]]>
    </select>
</dataset>

