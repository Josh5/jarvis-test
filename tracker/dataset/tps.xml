<!--
    This dataset provides details of average transactions per minute.
    It averages transactions over a 15 minute block (aligned on the hour), and 
    provides the average transactions per minute for that fifteen minute block.

    First REST parameter is the application name (optional)
    Second REST parameter is the dataset (or plugin) name (optional)

  -->
<dataset read="*" write="">
    <select>
    <![CDATA[
        SELECT 
            julian(cal.time) AS t -- Parsing of julian date is much faster than parsing a date string.
            , coalesce(r.transaction_count,0) / 15.0 AS c
        FROM 
            (SELECT the_date + i.interval as time FROM
                (
                SELECT the_date FROM calendar WHERE the_date >= {$from}::date AND the_date <= {$to}::date
                ) c,
                (
                SELECT interval FROM day_interval WHERE is_fifteen_minute
                ) i
            ) cal
            LEFT JOIN (
                SELECT
                    date_trunc_interval('15 minutes', start_time) AS start_time
                    , count(*) as transaction_count
                FROM (
                    SELECT start_time, username, app_name, dataset FROM request 
                    WHERE start_time >= {$from} AND start_time <= {$to}
                    UNION ALL 
                    SELECT start_time, username, app_name, dataset  FROM error
                    WHERE start_time >= {$from} AND start_time <= {$to}
                ) d
                WHERE (app_name IS NULL OR {$1}::text IS NULL OR {$1} = app_name)
                    AND (dataset IS NULL OR {$2}::text IS NULL OR {$2} like dataset || '%')
                    AND (username IS NULL OR {$user}::text IS NULL OR username = {$user})
                GROUP BY
                    date_trunc_interval('15 minutes', start_time)
            ) r ON
                cal.time = r.start_time
        WHERE
            cal.time >= {$from} AND cal.time <= {$to}
        ORDER BY
            cal.time
    ]]>
    </select>
</dataset>

