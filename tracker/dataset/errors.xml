<!--
     This dataset provides a list of the errors that have occurred.
     First REST parameter can be the application, if so wanted.
     Second REST parameter can be the user, if so wanted.

     Errors are returned latest error first.

     A limit is forced on the number of returned errors. If more than that
     occur for, say, a day, then filtering should be done using the 'filter'
     parameter.

     A 'limit_to_date' parameter can be passed in to limit the erors to a
     specific date (in server local time).
  -->
<dataset read="*" write="">
    <select>
        SELECT
            id,
            sid,
            app_name,
            username,
            group_list,
            dataset,
            action,
            params,
            post_body,
            message,
            strftime('%Y-%m-%dT%H:%M:%S', start_time, 'localtime')  AS start_time
        FROM
            error
        WHERE
            ({$1} IS NULL OR lower(app_name) = lower({$1}))
            AND ({$2} IS NULL OR lower(username) = lower({$2}))
            AND
            (
                {$filter} IS NULL OR {$filter} = ''
                OR
                id IN (SELECT id FROM error WHERE sid LIKE '%' || {$filter} || '%')
                OR
                id IN (SELECT id FROM error WHERE username LIKE '%' || {$filter} || '%')
                OR
                id IN (SELECT id FROM error WHERE dataset LIKE '%' || {$filter} || '%')
                OR
                id IN (SELECT id FROM error WHERE params LIKE '%' || {$filter} || '%')
                OR
                id IN (SELECT id FROM error WHERE message LIKE '%' || {$filter} || '%')
                OR
                id IN (SELECT id FROM error WHERE post_body LIKE '%' || {$filter} || '%')
            )
            AND
            (
                {$limit_to_date} IS NULL OR date(start_time, 'localtime') = date({$limit_to_date}, 'localtime')
            )
        ORDER BY
            start_time DESC
        LIMIT 100
    </select>
</dataset>
