<dataset read="*" write="">
    <!--
         Select details on all datasets on an application
         or a subsection of datasets on an application.

         REST arg 1 is the application name
         REST arg 2 is the dataset name 
      -->

    <select>
        <![CDATA[
        SELECT
            dataset || (CASE WHEN action = 'select' THEN ' (s)' WHEN action = 'insert' THEN ' (i)' WHEN action = 'update' THEN ' (u)' ELSE ' (d)' END) AS dataset,
            COUNT(*) AS number_of_requests,
            SUM (duration_ms) AS total_duration_ms,
            AVG (duration_ms) AS avg_duration_ms,
            MAX (duration_ms) AS max_duration_ms,
            MIN (duration_ms) AS min_duration_ms,
            AVG (CASE WHEN action = 'select' THEN out_nrows ELSE in_nrows END) AS avg_nrows
        FROM
            request
        WHERE
            (app_name = {$1} OR {$1}::text IS NULL)
            AND ({$2}::text IS NULL OR dataset LIKE {$2} || '%')
            AND ({$from}::timestamp IS NULL OR start_time >= {$from})
            AND ({$to}::timestamp IS NULL OR start_time <= {$to})
        GROUP BY
            dataset
            , action
        ORDER BY
            dataset
        ]]>
    </select>
</dataset>
