<dataset read="*" write="">
    <select>
        <![CDATA[
        SELECT
            username,
            COUNT(*) AS number_of_requests,
            COUNT(*) / extract(day from {$to}::timestamp - {$from}::timestamp) AS avg_daily_requests,
            AVG (CASE WHEN action = 'select' THEN out_nrows ELSE in_nrows END) AS avg_nrows
        FROM
            request
        WHERE
            (app_name = {$1} OR {$1}::text IS NULL)
            AND ({$from}::timestamp IS NULL OR start_time >= {$from})
            AND ({$to}::timestamp IS NULL OR start_time <= {$to})
        GROUP BY
            username
        ORDER BY
            username
        ]]>
    </select>
</dataset>

